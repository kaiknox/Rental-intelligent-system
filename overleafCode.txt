\documentclass[12pt, a4paper]{article}
\usepackage[spanish]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{hyperref}
\usepackage{geometry}
\usepackage{amsmath}
\usepackage{booktabs}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{float}

\geometry{margin=2.5cm}

\definecolor{codebg}{rgb}{0.95,0.95,0.95}
\lstset{
    backgroundcolor=\color{codebg},
    basicstyle=\ttfamily\small,
    breaklines=true,
    frame=single,
    captionpos=b,
    showstringspaces=false
}

\title{Práctica de Sistemas Basados en el Conocimiento \\ Recomendación de Viviendas en Alquiler}
\author{Kirian Roca, Kai Knox e Iván Alcubierre}

\begin{document}

\maketitle

% ============================
% PRIMERA PARTE: PLANTEAMIENTO DEL PROBLEMA
% ============================
\section{Introducción y planteamiento del problema}
\label{sec:intro}

\subsection{Estructura del documento}
Este documento se organiza en tres partes principales:

\begin{itemize}
    \item \textbf{Parte 1 (Introducción)}: Planteamiento del problema, objetivos y metodología.
    \item \textbf{Parte 2 (Desarrollo)}: Conceptualización, formalización (ontología) e implementación en CLIPS.
    \item \textbf{Parte 3 (Resultados)}: Casos de prueba, análisis de resultados, conclusiones y trabajo en equipo.
\end{itemize}

\subsection{Contexto y motivación}
La práctica plantea el desarrollo de un sistema de recomendación de viviendas en alquiler que pueda ser utilizado por una entidad pública para ayudar a los ciudadanos a encontrar ofertas adecuadas a sus necesidades. 

El problema implica combinar dos tipos de información:
\begin{itemize}
    \item \textbf{Características de las viviendas}: precio, superficie, tipo de propiedad, amenities, ubicación, etc.
    \item \textbf{Perfil y preferencias del usuario}: presupuesto, composición familiar, necesidades de proximidad a servicios, restricciones, etc.
\end{itemize}

La complejidad del dominio y la necesidad de aplicar conocimiento experto para ponderar múltiples factores convierten este problema en un caso idóneo para un Sistema Basado en el Conocimiento (SBC).

\subsection{Objetivos de la práctica}
El objetivo principal de esta práctica es diseñar e implementar un \textbf{Sistema Basado en el Conocimiento (SBC)} que emule el razonamiento de un experto inmobiliario para recomendar viviendas en alquiler. Los objetivos específicos son:

\begin{itemize}
    \item Analizar el dominio del problema e identificar las fuentes de conocimiento necesarias.
    \item Construir una ontología formal que represente los conceptos clave: \textbf{viviendas}, \textbf{solicitantes}, \textbf{servicios urbanos} y \textbf{zonas de la ciudad}.
    \item Implementar en CLIPS un sistema de reglas que realice:
    \begin{itemize}
        \item Evaluación de compatibilidad entre perfil del solicitante y características de la vivienda.
        \item Cálculo de proximidad a servicios relevantes (transporte, educación, ocio, salud, etc.).
        \item Clasificación de las recomendaciones en tres categorías: \textit{parcialmente adecuada}, \textit{adecuada} y \textit{muy recomendable}.
    \end{itemize}
    \item Validar el sistema mediante casos de prueba representativos y documentar el proceso de desarrollo siguiendo la metodología de ingeniería del conocimiento.
\end{itemize}

\subsection{Metodología de desarrollo}
Para desarollar el trabajo hemos seguido estos 5 pasos:

\begin{enumerate}
    \item \textbf{Identificación}: Análisis del enunciado, definición de objetivos y alcance.
    \item \textbf{Conceptualización}: Extracción y organización del conocimiento experto, identificación de conceptos y relaciones.
    \item \textbf{Formalización}: Construcción de la ontología en Protégé y diseño de la estrategia de razonamiento.
    \item \textbf{Implementación}: Codificación en CLIPS del sistema de reglas y hechos.
    \item \textbf{Prueba}: Validación mediante casos de prueba y análisis de resultados.
\end{enumerate}

% ============================
% SEGUNDA PARTE: DESARROLLO Y ELABORACIÓN DE LA SOLUCIÓN
% ============================
\section{Desarrollo de la solución}
\label{sec:desarrollo}

\subsection{Conceptualización}
\label{subsec:conceptualizacion}

\subsubsection{Extracción de conocimiento}
\textbf{Entrevista con experto IA (Gemini 3.0)}\\\\
%
    \textbf{Interviewer:} "We are going to do a role playing exercise. You are going to help a knowledge engineer perform knowledge elicitation for building a rule-based expert system for the recommendation of home rentals. You are a real estate agent with wide experience in this problem who knows how to match different kinds of people (families with or without children, students, single people, elderly) according to the characteristics of the home and its neighborhood. The knowledge engineer is going to ask about the characteristics, criteria, and knowledge that you use for making the decisions. Your answer should be direct and precise. The answers should be helpful for building rules for making decisions from the answers of people who are looking to rent a flat or a house."
% Contexto
	\textbf{Expert:} To build a robust recommendation system, we must classify clients into four specific archetypes, each with distinct priorities:
\begin{itemize}
\item \textbf{Elderly:} Their non-negotiable priority is Accessibility. If a property is not on the ground floor, it must have an elevator. They require essential services (Pharmacy, Supermarket) within short walking distance and strictly reject "Nightlife" zones due to noise.
\item \textbf{Families:} They prioritize Space and Safety. They need a specific number of bedrooms to match their family size. They prioritize proximity to Schools and Green Areas and avoid "High Noise" or "Tourist" districts.
\item \textbf{Students:} They are budget-driven but have specific technical needs. Internet and Furnishing are mandatory hard constraints. They will tolerate noise or older building conditions if the price is right. They prioritize proximity to the University or Public Transport.
\item \textbf{Young Couples/Professionals:} They prioritize Lifestyle. They value proximity to Gyms, Restaurants, and Leisure. If they own a car, a Garage becomes a critical requirement due to the Lifestyle urban location.
\end{itemize}

% Atributos iniciales proporcionados
	\textbf{Interviewer:} "Now I will send you a basis of the attributes for clients and properties that I am sure they have to be. Can you use your expert knowledge to suggest some attributes to make it more complete? 

% Property
\begin{enumerate}
\item Monthly price in euros.
\item Location (city district, address, GPS coordinates).
\item Usable floor area in m$^2$.
\item Number of bedrooms and whether they are double or single.
\item Whether the dwelling has a terrace or balcony.
\item Whether the dwelling is rented furnished and/or with appliances.
\item Type of dwelling: flat, duplex, single-family house. For flats or duplexes, the floor level (mezzanine, first, second...).
\item Other features such as: no-pets rule, heating/air conditioning, whether the flat gets sunlight (morning, afternoon, all day), access to a communal pool, parking space included, property with views. 
\end{enumerate}

% Clients
\begin{enumerate}
\item Maximum price they are willing to pay and whether the limit is strict or they could pay more if the offer is worth it.
\item Restrictions regarding the number/size of the bedrooms.
\item Minimum price, below which they believe the offer is too cheap to be adequate.
\item Specific restriction or preference regarding distance to certain services (schools nearby, public transport nearby...).
\item Whether they prefer to use public transport for commuting.
\item Age of the applicants.
\item Type of applicants: couple without children, couple planning to have children soon, family (single-parent, two-parent) with children/elderly dependents (number), group of students (number), individual...
\item Whether they work/study in the city and where the workplace/place of study is located.
\item Whether they own a car."
\end{enumerate}

% Atributos añadidos por el experto
	\textbf{Expert:} To strengthen the system and reduce ambiguity in decision rules, we need additional measurable attributes for both Property and Clients. These enable clearer constraints, preference scoring, and rule branching.
\paragraph{Property – Suggested Additional Attributes}
\begin{itemize}
\item Noise Level Classification: Quiet / Moderate / High. Necessary for Families and Elderly.
\item Accessibility Indicators: Presence of elevator, ramp access, door width for wheelchair. Critical for Elderly.
\item Energy Efficiency Rating: Impacts long-term cost; students and families react strongly to energy bills.
\item Internet Availability and Speed: Mandatory for Students; highly relevant for Couples/Professionals working remotely.
\item Heating Type and Insulation Quality: Relevant in older buildings; impacts comfort and utility expenses.
\item Proximity Metrics: Walking time (not just distance) to public transport, university/schools, supermarkets, pharmacy.
\item Neighborhood Category: Residential / Tourist / Nightlife / Business. Used to match lifestyle vs. noise tolerance.
\item Safety Indicators: Crime level or “perceived safe area” flag. Families care; students tolerate lower.
\item Building Age and Renovation Condition: Students tolerate older; families avoid degraded.
\item Contract Constraints: Minimum rental duration, deposit size. People with strict budgets (students) react strongly.
\item Pets Allowed / Forbidden: Already noted, but must be categorical because it blocks many options.
\end{itemize}

\paragraph{Clients – Suggested Additional Attributes}
\begin{itemize}
\item Noise Tolerance Level: Critical decision boundary between Elderly/Families vs. Students/Professionals.
\item Mobility or Accessibility Needs: Presence of disability or reduced mobility; elevator becomes hard constraint.
\item Internet Requirement: Binary but decisive.
\item Expected Lease Duration: Students short-term; families long-term. Impacts landlord suitability.
\item Work Modality: Remote/hybrid/on-site. Remote workers require strong internet and quiet environment.
\item Lifestyle Priority: Quiet, central/leisure-oriented, green areas, nightlife. Makes rule pruning more accurate.
\item Commute Distance Tolerance: Define acceptable walking/public transport travel time.
\item Car Usage Frequency: Not only ownership; usage defines need for guaranteed parking.
\end{itemize}
These additions allow the rules to be actionable and conflict-resolving instead of vague.

\subparagraph{}
	\textbf{Interviewer:} “Can you suggest some filters that you apply to decide if a Property is good to a certain client?”
	\textbf{Expert:} First, we must apply a hard financial filter before looking at preferences.
\paragraph{Financial Filters}
\begin{itemize}
\item The 40\% Rule: The monthly rent must not exceed 40\% of the household's total monthly income. This is a safety check for solvency.
\item Budget Limit: We respect the client's "Maximum Price," but we should allow a small margin (e.g., +10\%) if the property is "Ideal," unless the client marks their budget as "Strict."
\end{itemize}
Next, we apply structural and capacity filters to guarantee functional suitability:
\paragraph{Structural Filters}
\begin{itemize}
\item Bedroom/Occupancy Consistency: The number and type of bedrooms must align with the household size. A family of four cannot be matched with a single-bedroom flat. Couples planning children should not be placed in a studio.
\item Accessibility Compliance: If any applicant has reduced mobility or is elderly, the property must have either ground-floor access or a functioning elevator. Absence of these eliminates the property immediately.
\item Mandatory Utility Requirements: If the client requires high-speed internet (students, remote workers), or heating/air conditioning (elderly, families in cold/hot climates), properties without these features are discarded.
\item Transportation or Parking Constraint: If the client relies on public transport, the property must be within a reasonable walking radius of a reliable connection. If the client owns a car and parking is required, the property must provide either a garage or a guaranteed parking spot.
\item Neighborhood Compatibility: Noise and security conditions must be aligned with the sensitivity of the client type. Nightlife areas are automatically excluded for elderly or families. Tourist zones are low priority for families but acceptable for students.
\end{itemize}
These filters eliminate structurally incompatible options before any ranking or preference scoring begins.

\paragraph{Relación entre el conocimiento del experto y el código CLIPS:}

\subparagraph{Aplicado}
\begin{enumerate}
\item \textbf{Presupuesto}  
Se solicita precio máximo y si es estricto o flexible.  
Se descartan propiedades que superan el máximo; si es flexible se permite hasta 10\%.
\item \textbf{Dormitorios y espacio}  
Filtrado por número de dormitorios dobles y simples.
\item \textbf{Mascotas}  
Se descartan viviendas donde no se permiten mascotas.
\item \textbf{Coche}  
Atr. \texttt{owns-car}, propiedades con \texttt{Garage}. Eliminación o penalización según cliente.
\item \textbf{Trabajo/estudio}  
Se registran coordenadas de trabajo/estudio.
\item \textbf{Regla del 40\%}  
Se registra ingreso mensual total y se descartan viviendas fuera del presupuesto.
\item \textbf{Accesibilidad}  
Atributos de ascensor y planta; reglas para clientes sensibles.
\item \textbf{Ruido}  
Atributos de ruido recibidos; filtros por tipo de cliente.
\item \textbf{Seguridad}  
Atributo de nivel de seguridad; filtrado según cliente.
\item \textbf{Proximidad a servicios}  
Coordenadas de servicios y propiedades.
\item \textbf{Condiciones climáticas (sol)}  
Atributos de AC, heating y orientación solar.
\end{enumerate}

\subparagraph{No aplicado}
\begin{enumerate}
\item \textbf{Internet}  
Se considera que cada cliente contrata su propio servicio.
\item \textbf{Clima adicional no relacionado con sol}  
Se omiten factores climáticos globales para reducir complejidad del modelo.
\end{enumerate}

\subsubsection{Conceptos y relaciones principales}
A partir del análisis del dominio y de la experiencia en portales inmobiliarios, identificamos los siguientes conceptos clave, que posteriormente se formalizarán en la ontología:

\begin{itemize}
    \item \textbf{Cliente}: persona o grupo que busca vivienda. Se distingue entre:
    \begin{itemize}
        \item \textbf{Individual}: Adulto, Joven, Estudiante, Anciano.
        \item \textbf{Grupo}: Pareja (con o sin hijos previstos, joven o anciana), Familia (con o sin ancianos), Grupo de estudiantes.
    \end{itemize}
    
    \item \textbf{Vivienda}: oferta de alquiler. Incluye subtipos como:
    \begin{itemize}
        \item \textbf{Piso}, \textbf{Dúplex}, \textbf{Ático}, \textbf{Estudio}.
        \item \textbf{Casa individual}, \textbf{Casa pareada}, \textbf{Casa adosada}.
        \item \textbf{Habitación} para alquiler individual.
    \end{itemize}
    
    \item \textbf{Servicio}: elemento urbano que influye en la calidad de vida:
    \begin{itemize}
        \item \textbf{Transporte}: Parada de autobús, metro, tren, aparcamiento.
        \item \textbf{Educación}: Colegio, instituto, universidad.
        \item \textbf{Salud}: Clínica, hospital, farmacia.
        \item \textbf{Comercio}: Supermercado, hipermercado, centro comercial, tienda.
        \item \textbf{Ocio}: Parque, piscina, gimnasio, cine, museo, zona de vida nocturna, restaurante, playa, polideportivo.
    \end{itemize}
    
    \item \textbf{Zona}: área de la ciudad con características homogéneas:
    \begin{itemize}
        \item \textbf{Residencial}, \textbf{Centro}, \textbf{Núcleo urbano}, \textbf{Negocios}, \textbf{Industrial}.
    \end{itemize}
\end{itemize}

\paragraph{Relaciones principales identificadas:}
\begin{itemize}
    \item Una \textbf{Vivienda} \textit{está ubicada en} una \textbf{Zona} (relación \texttt{is\_located\_in\_zone}).
    \item Una \textbf{Vivienda} \textit{está cerca de} uno o más \textbf{Servicios} (relación \texttt{is\_near\_service}).
    \item Un \textbf{Cliente} \textit{tiene preferencias y restricciones} sobre:
    \begin{itemize}
        \item Precio máximo, flexibilidad presupuestaria, precio mínimo sospechoso (\textit{too bargain}).
        \item Número mínimo de dormitorios y baños.
        \item Necesidad de transporte público, posesión de coche.
        \item Ubicación de trabajo/estudio (coordenadas).
        \item Mascotas, ruido tolerado, características deseadas (terraza, ascensor, amueblado, etc.).
    \end{itemize}
    \item Una \textbf{Vivienda} \textit{puede satisfacer o no} dichas preferencias, lo que determina su \textbf{grado de recomendación} (parcialmente adecuada, adecuada, muy recomendable).
\end{itemize}

\subsection{Formalización}
\label{subsec:formalizacion}


\subsubsection{Ontología del dominio}
La ontología se ha construido en Protégé siguiendo la metodología de desarrollo de ontologías 101, y está compuesta por 4 conceptos raíz principales, sus jerarquías de subclases, propiedades de objeto y datos, y restricciones de dominio/rango.

\paragraph{Jerarquía de clases}
\begin{itemize}
    \item \textbf{\texttt{Client\_Group}}: representa a los solicitantes. Se divide en:
    \begin{itemize}
        \item \textbf{\texttt{Individual}}: \texttt{Adult}, \texttt{Young}, \texttt{Student}, \texttt{Elderly}.
        \item \textbf{\texttt{Group}}: \texttt{Couple} (\texttt{Elderly\_Couple}, \texttt{Planning\_Kids}, \texttt{Young\_No\_Kids}), \texttt{Family} (\texttt{No\_Elderly}, \texttt{With\_Elderly}), \texttt{Student\_Group}.
    \end{itemize}
    Se ha modelado así para capturar perfiles con necesidades diferenciadas (ej: jóvenes buscan ocio, familias buscan escuelas).
    
    \item \textbf{\texttt{Property}}: representa las viviendas en alquiler. Incluye:
    \begin{itemize}
        \item Tipos urbanos: \texttt{Apartment}, \texttt{Duplex}, \texttt{Penthouse}, \texttt{Studio}, \texttt{Triplex}, \texttt{Room}.
        \item Tipos unifamiliares: \texttt{Detached\_House}, \texttt{Semidetached\_House}, \texttt{Row\_House}, \texttt{Single-family\_House}.
    \end{itemize}
    Se han definido como \textit{disjoint} para evitar inconsistencias.
    
    \item \textbf{\texttt{Service}}: modela los servicios urbanos. Subclases:
    \begin{itemize}
        \item \texttt{Transport} (\texttt{Bus\_stop}, \texttt{Metro\_station}, \texttt{Train\_station}, \texttt{Parking}, \texttt{Clable\_car\_station}).
        \item \texttt{Education} (\texttt{School}, \texttt{High\_School}, \texttt{University}).
        \item \texttt{Healthcare} (\texttt{Clinic}, \texttt{Hospital}, \texttt{Pharmacy}).
        \item \texttt{Shopping} (\texttt{Supermarket}, \texttt{Hipermarket}, \texttt{Mall}, \texttt{Store}).
        \item \texttt{Recreation} (\texttt{Park}, \texttt{Pool}, \texttt{Gym}, \texttt{Beach}, \texttt{Cinema}, \texttt{Museum}, \texttt{Nightlife}, etc.).
    \end{itemize}
    Esta categorización permite evaluar la proximidad a servicios de forma estructurada.
    
    \item \textbf{\texttt{Zone}}: describe zonas de la ciudad:
    \begin{itemize}
        \item \texttt{Residential}, \texttt{Business}, \texttt{Downtown}, \texttt{Industrial}, \texttt{Urban\_core}.
    \end{itemize}
    Cada zona tiene atributos como nivel de ruido y seguridad.
\end{itemize}

\paragraph{Propiedades de objeto}
\begin{itemize}
    \item \texttt{is\_located\_in\_zone}: relaciona una \texttt{Property} con una \texttt{Zone}. Es funcional (cada vivienda está en una sola zona).
    \item \texttt{is\_near\_service}: relaciona una \texttt{Property} con un \texttt{Service}. Permite modelar proximidad a múltiples servicios.
\end{itemize}

\paragraph{Propiedades de datos}
Se han agrupado en tres categorías para facilitar la modularidad:
\begin{itemize}
    \item \texttt{property\_attribute}: atributos de la vivienda (precio, metros², habitaciones, terraza, ascensor, amueblado, etc.).
    \item \texttt{client\_attribute}: atributos del solicitante (edad, presupuesto, preferencias, ubicación trabajo/estudio, etc.).
    \item \texttt{zone\_attribute}: atributos de la zona (nivel de ruido, seguridad).
\end{itemize}
Se han usado tipos de datos específicos (\texttt{boolean}, \texttt{int}, \texttt{float}) y enumerados (ej: \texttt{Sun\_Time}: \texttt{Morning}, \texttt{Afternoon}, \texttt{All\_Day}, \texttt{Never}).

\paragraph{Decisiones de diseño justificadas}
\begin{itemize}
    \item \textbf{Coordenadas enteras}: se usan \texttt{geo\_lat} y \texttt{geo\_long} como enteros para simplificar el cálculo de distancias en CLIPS.
    \item \texttt{floor\_level} solo aplica a \texttt{Apartment}, \texttt{Room} y \texttt{Studio}, no a viviendas unifamiliares.
    \item \texttt{Too\_Bargain}: se incluye como atributo del cliente para detectar precios sospechosamente bajos.
    \item \textit{Disjoint} entre clases: evita que una misma instancia sea, por ejemplo, un \texttt{Apartment} y una \texttt{Detached\_House}.
\end{itemize}

\subsubsection{Metodología de resolución de problemas}
Usamos clasificación huerística como metodología de resolución de problemas y la dividimos en estas partes: 

\begin{enumerate}
    \item \textbf{Reglas de abstracción:} 
    Para transformar datos concretos (coordenadas, edades, precios) en categorías simbólicas que permiten una evaluación cualitativa. Esto incluye:
    \begin{itemize}
        \item Abstracción implícita (datos ya categóricos).
        \item Abstracción inducida (preferencias deducidas del perfil demográfico).
        \item Abstracción explícita (cálculo de distancias y ratios).
    \end{itemize}

    \item \textbf{Reglas de Clasificación Heurística:} 
    Cada propiedad se evalúa contra una lista de criterios derivados del perfil del cliente. En lugar de una puntuación numérica, se utiliza un sistema de \textit{checklist} cualitativo que registra cumplimientos, fallos y extras.

    \item \textbf{Clasificación por categorías predefinidas:} 
    El resultado de la evaluación de clasificación heurística se traduce a una de cuatro categorías de recomendación, facilitando la interpretación por parte del usuario final.

    \item \textbf{Estrategia de búsqueda exhaustiva:} 
    El sistema evalúa \textbf{todas} las propiedades disponibles contra el perfil del cliente, sin poda temprana, garantizando que ninguna opción potencialmente adecuada sea descartada prematuramente.
\end{enumerate}

Esta metodología permite un balance entre flexibilidad (acepta múltiples tipos de clientes y propiedades) y transparencia (el usuario puede ver qué criterios se cumplen o fallan).

\subsubsection{Diseño del Sistema de Reglas}
\label{subsubsec:diseno-reglas}

El sistema implementa tres tipos principales de reglas que permiten transformar los datos concretos del dominio en conocimiento abstracto para la toma de decisiones. Estas reglas siguen la metodología de resolución de problemas descrita anteriormente.

\paragraph{2.2.3.1 Reglas de Abstracción}
\label{par:reglas-abstraccion}

Estas reglas realizan la transición del \textbf{problema concreto} al \textbf{problema abstracto}, transformando datos brutos en atributos categóricos que permiten una evaluación sistemática. Se dividen en tres subtipos:

\textbf{Reglas de Abstracción Implícita:} La información ya se encuentra en formato abstracto cuando el usuario la proporciona. No se requiere procesamiento adicional.

\begin{itemize}
    \item \textbf{Ejemplo:} Cuando el usuario responde \textit{``¿Tiene coche propio?''} con \texttt{yes}, el sistema asigna directamente \texttt{yes} al atributo \texttt{owns\_car}.
    \item \textbf{Otros ejemplos:} \texttt{has\_pets}, \texttt{Budget\_Is\_Strict}, \texttt{Works\_In\_City}.
\end{itemize}

\textbf{Reglas de Abstracción Inducida:} Se infieren preferencias a partir de información demográfica, basándose en conocimiento experto sobre patrones comunes.

\begin{itemize}
    \item \textbf{Ejemplo:} Si el cliente es clasificado como \texttt{Elderly}, \texttt{Elderly\_Couple} o \texttt{With\_Elderly}, el sistema induce preferencias como \lstinline{"elevator"}, \lstinline{"quiet"}, \lstinline{"single-floor"}, \lstinline{"healthcare"}.
    \item Estas preferencias se añaden automáticamente a \texttt{desired\_features}.
\end{itemize}

\textbf{Reglas de Abstracción Explícita:} Transforman datos numéricos o geográficos en categorías simbólicas mediante fórmulas y umbrales predefinidos. Estas reglas realizan cálculos concretos que permiten evaluar características espaciales y cuantitativas de las propiedades.

\begin{itemize}
    \item \textbf{Cálculo de densidad de habitaciones (\texttt{room-density}):} 
    Para determinar si una propiedad tiene espacio suficiente para el grupo de clientes, el sistema calcula:
    \[
    \text{capacidad} = (\text{Num\_Double\_Rooms} \times 2) + \text{Num\_Single\_Rooms}
    \]
    \[
    \text{ratio} = \frac{\text{capacidad}}{\text{num\_people}}
    \]
    La clasificación resultante es:
    \begin{itemize}
        \item \texttt{saturated} (ratio < 1.0): insuficiente espacio
        \item \texttt{sufficient} (ratio = 1.0): espacio justo
        \item \texttt{spacious} (ratio > 1.0): espacio abundante
    \end{itemize}

    \item \textbf{Cálculo de distancias euclidianas:} 
    Todas las mediciones de proximidad se basan en la función \texttt{euclid-dist}, que calcula la distancia en línea recta entre dos puntos geográficos:
    \[
    \text{distancia}(x_1, y_1, x_2, y_2) = \sqrt{(x_1 - x_2)^2 + (y_1 - y_2)^2}
    \]
    Donde $(x_1, y_1)$ y $(x_2, y_2)$ son las coordenadas enteras de los puntos a comparar.

    \item \textbf{Asignación de servicios cercanos:} 
    Aplicando la función \texttt{euclid-dist}, el sistema clasifica la proximidad de cada servicio a una propiedad mediante dos reglas:
    \begin{itemize}
        \item \texttt{inicio-calcular-cercania}: servicio $\leq$ 200 m $\rightarrow$ \texttt{is\_near\_service}
        \item \texttt{inicio-calcular-media-cercania}: servicio entre 200-700 m $\rightarrow$ \texttt{is\_semi\_near\_service}
    \end{itemize}
    Estas reglas se ejecutan al inicio del sistema con prioridad alta (\texttt{salience 100} y \texttt{99}) para garantizar que todas las conexiones se establezcan antes del proceso de recomendación.

    \item \textbf{Cálculo de distancias a trabajo/estudio para grupos:} 
    Cuando múltiples personas trabajan o estudian en diferentes ubicaciones, el sistema implementa una estrategia conservadora considerando la \textbf{peor situación}. Para cada propiedad:
    
    \begin{enumerate}
        \item Se calcula la distancia entre la propiedad y cada ubicación de trabajo/estudio usando \texttt{euclid-dist}.
        \item Se determina la \textbf{distancia máxima} mediante la función \texttt{max-distance}, que itera sobre todas las coordenadas proporcionadas.
        \item Esta distancia máxima se clasifica según umbrales predefinidos:
        \begin{itemize}
            \item \texttt{< 1000 m} $\rightarrow$ \texttt{cerca}
            \item \texttt{1000–3500 m} $\rightarrow$ \texttt{media\_distancia}
            \item \texttt{> 3500 m} $\rightarrow$ \texttt{lejos}
        \end{itemize}
    \end{enumerate}
    
    \textbf{Justificación del diseño:} Esta aproximación garantiza que la recomendación sea válida para todos los miembros del grupo, incluso para quien tenga el trayecto más largo. Si la propiedad satisface la distancia máxima, automáticamente satisface las distancias menores de otros miembros.

    \item \textbf{Función de clasificación de distancias:} 
    La función auxiliar \texttt{classify-distance} encapsula la lógica de umbrales, permitiendo una modificación centralizada de los criterios de proximidad si fuera necesario en futuras versiones del sistema.
\end{itemize}

\paragraph{2.2.3.2 Reglas de Evaluación de Criterios}
\label{par:reglas-evaluacion}

Una vez obtenidos los atributos abstractos, el sistema evalúa cada propiedad contra los criterios del cliente. Estas reglas comparan características específicas y generan evaluaciones cualitativas.

\textbf{Ejemplos de criterios evaluados:}

\begin{itemize}
    \item \textbf{Compatibilidad presupuestaria:} Compara \texttt{monthly\_price} de la propiedad con \texttt{max\_budget} del cliente.
    \item \textbf{Compatibilidad con mascotas:} Verifica \texttt{Pets\_Allowed} de la propiedad contra \texttt{has\_pets} del cliente.
    \item \textbf{Densidad adecuada:} Evalúa \texttt{room-density} para determinar si hay suficiente espacio.
    \item \textbf{Distancia a servicios clave:} Comprueba proximidad a trabajo/estudio según categorías \texttt{cerca}, \texttt{media\_distancia}, \texttt{lejos}.
    \item \textbf{Satisfacción de características deseadas:} Para cada elemento en \texttt{desired\_features}, verifica si la propiedad lo cumple mediante la función \texttt{feature-satisfied}.
\end{itemize}

\textbf{Salida de estas reglas:} Cada propiedad recibe dos listas:
\begin{itemize}
    \item \texttt{met-criteria}: Criterios que satisface.
    \item \texttt{failed-criteria}: Criterios que no satisface.
    \item \texttt{extra-criteria}: Características adicionales positivas no solicitadas explícitamente.
    \item \texttt{missing-criteria}: Características negativas no solicitadas explícitamente.
\end{itemize}

\paragraph{2.2.3.3 Reglas de Clasificación y Recomendación}
\label{par:reglas-clasificacion}

Finalmente, el sistema clasifica cada propiedad en una de cuatro categorías de recomendación basándose en los resultados de la evaluación.

\textbf{Lógica de clasificación implementada:}

\begin{enumerate}
    \item \textbf{No recomendado:} Si la propiedad falla en más de 3 criterios esenciales.
    \item \textbf{Parcialmente adecuada:} Si falla en 1-3 criterios, pero satisface los esenciales.
    \item \textbf{Adecuada:} Si satisface todos los criterios sin características extras destacables.
    \item \textbf{Muy recomendable:} Si satisface todos los criterios y además tiene características extras valoradas (ej: estado excelente, parque cercano, terraza, piscina).
\end{enumerate}

\textbf{Estrategia de implementación:} La regla \texttt{classify-property} analiza las listas \texttt{failed-criteria} y \texttt{extra-criteria} para asignar la categoría final. Esta clasificación permite presentar al usuario un ranking cualitativo de las propiedades disponibles.

\textbf{Ejemplo de salida:}
\begin{verbatim}
Propiedad apt-101 -> muy-adecuado
  Pros: [entra-en-presupuesto, admite-mascotas, ...]
  Contras: ninguno
  Extras: [estado-excelente, parque-cerca]
\end{verbatim}

\subsection{Implementación en CLIPS}
\label{subsec:implementacion}

\subsubsection{Estructura del proyecto}
El sistema está organizado en varias partes claramente separadas mediante comentarios en el código CLIPS, que se ejecutan en un orden lógico controlado por salience (prioridad):

\begin{enumerate}
    \item \textbf{Lógica de startup y cálculo de proximidad (salience 100-99):} 
    Inicializa las conexiones entre propiedades y servicios cercanos mediante reglas \texttt{inicio-calcular-cercania} e \texttt{inicio-calcular-media-cercania}.

    \item \textbf{Herramientas de entrevista (funciones):} 
    Contiene funciones utilitarias para la interacción con el usuario: \texttt{ask-number}, \texttt{ask-int-range}, \texttt{ask-yes-no}, \texttt{ask-coordinate}, etc.

    \item \textbf{Estructura de datos temporal:} 
    Define el \texttt{deftemplate user-responses} que almacena las respuestas del cuestionario paso a paso.

    \item \textbf{Reglas del flujo de preguntas (salience variable):} 
    Implementa el cuestionario guiado mediante reglas encadenadas que modifican el paso actual en \texttt{user-responses}. Incluye detección automática de perfiles (parejas, estudiantes).

    \item \textbf{Lógica de clasificación y creación de instancia:} 
    Contiene la regla \texttt{determine-and-create-client-final} que, mediante un árbol de decisión, clasifica al cliente en una subclase específica y crea la instancia correspondiente.

    \item \textbf{Cálculo de distancias trabajo/estudio y densidad (salience -20):} 
    Calcula atributos abstractos para cada propiedad respecto al cliente creado: \texttt{work-place}, \texttt{study-place}, \texttt{room-density}.

    \item \textbf{Recomendación cualitativa por criterios (salience -40 a -45):} 
    Evalúa cada propiedad contra los criterios del cliente, genera listas de cumplimientos/fallos/extras, y clasifica la propiedad en una categoría final de recomendación.
\end{enumerate}

\textbf{Hechos iniciales:} El sistema se inicia con el hecho \texttt{(start-execution)} y las instancias predefinidas en \texttt{definstances} (zonas, servicios y propiedades con atributos realistas y coordenadas coherentes).

\subsubsection{Ejemplo de reglas clave}

El sistema implementa diversos tipos de reglas que cubren desde la inicialización del sistema hasta la recomendación final. A continuación se muestran fragmentos comentados de algunas reglas representativas.

\begin{lstlisting}[language=Lisp, caption=Regla de inicialización: cálculo de proximidad a servicios]
;; Conecta propiedades con servicios cercanos (<=200m)
(defrule inicio-calcular-cercania
   (declare (salience 100)) ; Prioridad máxima: se ejecuta primero
   ?p <- (object (is-a Property) 
                 (geo_lat ?plat) (geo_long ?plong) 
                 (is_near_service $?lista))
   ?s <- (object (is-a Service) 
                 (geo_lat ?slat) (geo_long ?slong))
   
   ;; Evita duplicados: solo si el servicio NO está ya en la lista
   (test (eq (member$ ?s ?lista) FALSE))
   ;; Condición de distancia: 200 metros o menos
   (test (<= (euclid-dist ?plat ?plong ?slat ?slong) 200))
   =>
   ;; Acción: añade el servicio a la lista de cercanías
   (send ?p put-is_near_service (insert$ ?lista 1 ?s))
   (printout t "Sistema: Conectado " (instance-name ?p) 
             " con servicio cercano " (instance-name ?s) crlf)
)
\end{lstlisting}

Esta regla se ejecuta con prioridad máxima (\texttt{salience 100}) al inicio del sistema. Su función es precalcular las relaciones espaciales entre propiedades y servicios, almacenando en el multislot \texttt{is\_near\_service} todos los servicios ubicados a menos de 200 metros. Este cálculo inicial optimiza el sistema, evitando recalcular distancias durante la evaluación de cada cliente.

\begin{lstlisting}[language=Lisp, caption=Regla del flujo de entrevista: captura de datos económicos]
;; Paso 3 del cuestionario: información económica básica
(defrule ask-economics
   ?f <- (user-responses (step ask-economics))
   =>
   ;; Preguntas interactivas al usuario
   (bind ?inc (ask-number "¿Cual es vuestro ingreso mensual total (neto)?"))
   (bind ?bud (ask-number "¿Cual es vuestro presupuesto maximo objetivo?"))
   (bind ?strict (ask-yes-no "¿Es este presupuesto estricto (no podeis pagar mas)?"))
   (bind ?car (ask-yes-no "¿Teneis coche propio?"))
   (bind ?pet (ask-yes-no "¿Teneis mascotas?"))
   
   ;; Actualiza el template temporal con las respuestas
   (modify ?f (income ?inc)
              (max_budget ?bud)
              (budget_is_strict ?strict)
              (owns-car ?car)
              (has-pets ?pet)
              (step ask-work-logistics)) ; Pasa al siguiente paso
)
\end{lstlisting}

Esta regla forma parte del motor de entrevista interactiva. Utiliza funciones auxiliares (\texttt{ask-number}, \texttt{ask-yes-no}) para capturar datos del usuario y actualiza el \texttt{deftemplate} temporal \texttt{user-responses}. El sistema avanza modificando el slot \texttt{step}, lo que activa la siguiente regla del flujo.

\begin{lstlisting}[language=Lisp, caption=Regla de clasificación: árbol de decisión para individuos]
;; Fragmento de la regla determine-and-create-client-final
(if (= ?np 1) then  ; CASO 1: INDIVIDUAL
    (printout t "DEBUG: Rama INDIVIDUAL" crlf)
    (if ?has-elderly then
        (bind ?class-name Elderly)
        (printout t "DEBUG: Asignado ELDERLY" crlf)
    else
        (if (eq ?s-any yes) then
            (bind ?class-name Student)
            (printout t "DEBUG: Asignado STUDENT" crlf)
        else
            (if (<= (nth$ 1 ?ages) 30) then 
                (bind ?class-name Young)
                (printout t "DEBUG: Asignado YOUNG" crlf)
            else 
                (bind ?class-name Adult)
                (printout t "DEBUG: Asignado ADULT" crlf)
            )
        )
    )
)
\end{lstlisting}

Este fragmento muestra la lógica de clasificación para clientes individuales. El sistema evalúa secuencialmente: 1) si es anciano (edad ≥ 65), 2) si es estudiante (estudia en la ciudad), 3) si es joven (edad ≤ 30), 4) en caso contrario, adulto. Esta estructura de árbol de decisión codifica el conocimiento experto sobre las características distintivas de cada perfil.

\begin{lstlisting}[language=Lisp, caption=Regla de evaluación: cálculo de densidad de habitaciones]
;; Calcula si la propiedad tiene espacio suficiente para el grupo
(defrule calculate-room-density
   (declare (salience -20)) ; Prioridad baja: se ejecuta después
   (current-client ?client-id)
   ?client <- (object (is-a Client_Group) 
                      (num_people ?num-people))
   ?prop <- (object (is-a Property) 
                    (Num_Double_Rooms ?double-rooms)
                    (Num_Single_Rooms ?single-rooms))
   (not (room-density-done ?prop)) ; Evita recálculos
   =>
   ;; Capacidad total: habitaciones dobles cuentan como 2 plazas
   (bind ?capacity (+ (* ?double-rooms 2) ?single-rooms))
   
   ;; Ratio: capacidad / número de personas
   (bind ?ratio (/ ?capacity ?num-people))
   
   ;; Clasificación según umbrales predefinidos
   (bind ?density
       (if (< ?ratio 1.0) then saturated
        else (if (= ?ratio 1.0) then sufficient
              else spacious)))
   
   (send ?prop put-room-density ?density)
   (assert (room-density-done ?prop)) ; Marca como procesado
)
\end{lstlisting}

Esta regla de abstracción transforma datos concretos (número de habitaciones) en categorías simbólicas (\texttt{saturated}, \texttt{sufficient}, \texttt{spacious}). El uso de \texttt{salience -20} asegura que se ejecute después de la creación del cliente, y el hecho \texttt{room-density-done} evita procesamientos redundantes.

\begin{lstlisting}[language=Lisp, caption=Regla de evaluación principal: criterios básicos]
;; Evalúa múltiples criterios contra una propiedad
(defrule evaluate-basic-criteria
   (declare (salience -40))
   (current-client ?cid)
   ?c <- (object (is-a Client_Group)
                 (has_pets ?pets)
                 (max_budget ?maxb)
                 (Works_In_City ?works)
                 (Study_In_City ?studies)
                 (desired_features $?feat))
   ?p <- (object (is-a Property)
                 (monthly_price ?price)
                 (Pets_Allowed ?pets-ok)
                 (room-density ?dens)
                 (work-place ?workplace)
                 (study-place ?studyplace))
   =>
   (bind ?fails (create$))
   (bind ?mets (create$))
   
   ;; Criterio 1: Presupuesto (filtro duro)
   (if (> ?price ?maxb)
       then (bind ?fails (insert$ ?fails 1 fuera-de-presupuesto))
       else (bind ?mets  (insert$ ?mets  1 entra-en-presupuesto)))
   
   ;; Criterio 2: Mascotas
   (if (eq ?pets yes) then
       (if (eq ?pets-ok no)
            then (bind ?fails (insert$ ?fails 1 no-admite-mascotas))
            else (bind ?mets  (insert$ ?mets  1 admite-mascotas))))
   
   ;; Criterios 3-5: Densidad, trabajo, estudio
   (if (eq ?dens saturated)
       then (bind ?fails (insert$ ?fails 1 poco-espacio)))
   
   (if (eq ?works yes) then
       (if (eq ?workplace lejos)
           then (bind ?fails (insert$ ?fails 1 lejos-trabajo))
           else (bind ?mets  (insert$ ?mets  1 cerca-trabajo))))
   
   ;; Evaluación de características deseadas dinámicamente
   (foreach ?f ?feat
     (if (feature-satisfied ?p ?f)
         then (bind ?mets (insert$ ?mets 1 (sym-cat cumple- ?f)))
         else (bind ?fails (insert$ ?fails 1 (sym-cat falta- ?f)))))
   
   (assert (prop-assessment (prop (instance-name ?p))
                            (failed-criteria ?fails)
                            (met-criteria ?mets)))
)
\end{lstlisting}

Esta regla es el núcleo del sistema de evaluación. Implementa una estrategia de \textit{checklist} múltiple donde cada propiedad se evalúa contra todos los criterios relevantes del cliente. Los resultados se almacenan en el template \texttt{prop-assessment} para su posterior clasificación. La función \texttt{feature-satisfied} permite evaluar dinámicamente características específicas solicitadas por el cliente.

\paragraph{Resumen de tipos de reglas implementadas:}

\begin{table}[H]
\centering
\caption{Clasificación de reglas en el sistema CLIPS}
\begin{tabular}{p{0.25\textwidth}|p{0.3\textwidth}|p{0.25\textwidth}}
\toprule
\textbf{Tipo de regla} & \textbf{Función principal} & \textbf{Ejemplo} \\
\midrule
Reglas de inicialización & Precalcular relaciones espaciales & \texttt{inicio-calcular-cercania} \\
Reglas de flujo & Guiar la entrevista interactiva & \texttt{ask-economics}, \texttt{ask-work-logistics} \\
Reglas de clasificación & Determinar perfil del cliente & \texttt{determine-and-create-client-final} \\
Reglas de abstracción & Transformar datos en categorías & \texttt{calculate-room-density} \\
Reglas de clasificación heurística & Comparar propiedad con criterios & \texttt{evaluate-basic-criteria} \\
Reglas de recomendación & Asignar categoría final & \texttt{classify-property} \\
\bottomrule
\end{tabular}
\end{table}

El sistema utiliza \texttt{salience} (prioridad) para controlar el orden de ejecución: las reglas de inicialización tienen prioridad alta (100-99), las de evaluación media (-20 a -40), y las de recomendación prioridad baja (-45). Este diseño asegura que todos los datos necesarios estén calculados antes de tomar decisiones de recomendación.

\subsubsection{Desarrollo incremental}
\label{subsubsec:desarrollo-incremental}

El desarrollo del sistema siguió una estrategia incremental, construyendo prototipos funcionales que evolucionaron hasta la versión final:

\begin{enumerate}
    \item \textbf{Prototipo 1: Ontología y datos básicos.} 
    Se creó la ontología en Protégé con las cuatro jerarquías principales (Client\_Group, Property, Service, Zone) y se exportó a CLIPS mediante la herramienta \texttt{owl2clips}. Se definieron instancias de prueba mínimas (3 propiedades, 5 servicios) para validar la estructura básica.
    
    \item \textbf{Prototipo 2: Entrevista y clasificación del cliente.} 
    Se implementó el flujo de preguntas interactivo con reglas encadenadas (\texttt{ask-economics}, \texttt{ask-work-logistics}, etc.) y la lógica de clasificación demográfica en la regla \texttt{determine-and-create-client-final}. En esta versión, las recomendaciones se basaban únicamente en edad y número de personas, sin considerar servicios ni distancias.
    
    \item \textbf{Prototipo 3: Cálculo de proximidades y distancias.} 
    Se añadieron las funciones de distancia euclidiana (\texttt{euclid-dist}) y las reglas de startup \texttt{inicio-calcular-cercania} e \texttt{inicio-calcular-media-cercania} para conectar propiedades con servicios. También se implementó el cálculo de distancias a trabajo/estudio mediante las reglas \texttt{calculate-work-distances} y \texttt{calculate-study-distances}.
    
    \item \textbf{Prototipo 4: Implementación de reglas de abstracción y asociación heurística.} 
    Se desarrollaron dos categorías principales de reglas:
    \begin{itemize}
        \item \textbf{Reglas de abstracción:} Transforman datos concretos en categorías simbólicas. Se implementaron reglas como \texttt{calculate-room-density} (clasifica densidad de habitaciones como \texttt{saturated}, \texttt{sufficient} o \texttt{spacious}) y las funciones de clasificación de distancias (\texttt{classify-distance}).
        \item \textbf{Reglas de asociación heurística:} Aplican conocimiento experto para evaluar compatibilidad entre propiedades y clientes. La regla principal \texttt{evaluate-basic-criteria} implementa un sistema de \textit{checklist} que compara múltiples atributos del cliente con los de la propiedad, generando listas de criterios cumplidos y fallados.
    \end{itemize}
    Se introdujo la clasificación final mediante la regla \texttt{classify-property} que, basándose en los resultados de las reglas anteriores, asigna categorías de recomendación (\texttt{parcial}, \texttt{adecuado}, \texttt{muy-adecuado}, \texttt{ideal}).
    
    \item \textbf{Prototipo final: Depuración y datos realistas.} 
    Se expandió el conjunto de instancias en \texttt{definstances} a 20 propiedades y 50+ servicios con coordenadas coherentes. Se afinaron los umbrales de distancia, se añadieron criterios extras (orientación solar, calefacción, mobiliario) y se implementaron mecanismos para evitar bucles infinitos (\texttt{test (member\$ ...)}) y reprocesamiento (\texttt{work-distance-done}, \texttt{study-distance-done}). Se ajustaron las prioridades (\texttt{salience}) para optimizar el flujo de ejecución.
\end{enumerate}

Cada prototipo fue probado con casos específicos, permitiendo detectar y corregir inconsistencias (ej: servicios duplicados en listas, clasificación errónea de parejas sin hijos, manejo de coordenadas múltiples). Este enfoque incremental permitió validar cada componente del sistema de forma aislada antes de integrarlo en el conjunto, reduciendo la complejidad del proceso de depuración y facilitando la identificación temprana de problemas de diseño.

% ============================
% TERCERA PARTE: RESULTADOS Y CONCLUSIONES
% ============================
\section{Resultados y validación}
\label{sec:resultados}

\subsection{Juegos de prueba}
Explicación de cómo se seleccionaron los casos: perfiles variados (estudiante, familia, pareja), casos límite, cobertura de funcionalidades.

\subsection{Ejecución de pruebas}
Tabla resumen con al menos 6 casos diferentes, mostrando:
\begin{itemize}
    \item Perfil de entrada.
    \item Viviendas recomendadas (adecuadas, parcialmente adecuadas, muy recomendables).
    \item Criterios incumplidos o características destacadas.
\end{itemize}

\begin{table}[h]
\centering
\caption{Ejemplo de casos de prueba}
\begin{tabular}{p{3cm}|p{3cm}|p{3cm}|p{3cm}}
\toprule
\textbf{Perfil} & \textbf{Vivienda} & \textbf{Grado} & \textbf{Observaciones} \\
\midrule
Estudiante, precio bajo & Atico céntrico & Parcial & Sin terraza \\
Familia con hijos & Dúplex con jardín & Muy recomendable & Cerca de colegio y parque \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Análisis de resultados}
Explicación de por qué el sistema toma ciertas decisiones, ejemplos concretos basados en el conocimiento codificado.

\subsection{Conclusiones}
\label{subsec:conclusiones}

\subsubsection{Logros y dificultades}
Qué se ha conseguido, qué partes fueron más complejas, limitaciones del sistema.

\subsubsection{Trabajo en equipo}
Breve descripción de cómo se organizó el grupo, reuniones, reparto de tareas, uso de la planificación propuesta.

\subsubsection{Posibles mejoras}
Extensiones futuras: integración con datos reales de mapas, más factores de ponderación, interfaz gráfica.

% ============================
% ANEXOS
% ============================
\appendix
\section{Anexo A: Ontología completa}
Gráfico exportado desde Protégé con la jerarquía de clases y propiedades.

\section{Anexo B: Diálogo con modelo de lenguaje}
Si aplica: contexto usado, preguntas más relevantes y respuestas resumidas.

\section{Anexo C: Código fuente completo}
Listado completo del código CLIPS (o enlace al repositorio).

\end{document}